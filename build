#!/bin/bash

set -eo pipefail

rm -rf tmp
mkdir -p tmp

./util/conv.py misc/smbdis.asm

LIST=$(ls -1 src/*.cc)

set -e
set -x

scripts/gen_compile_flags  > compile_flags.txt

echo $LIST | xargs -n1 -P6 ./scripts/cxx-compile

cat tmp/main.ll | { egrep -A1 'tail call void .*VBlank1.*' || true ; }
cat tmp/main.s | { egrep '\s+b\s.*VBlank1.*' || true ; }
./scripts/cxx-link $(find tmp/ -type f -name \*\.o)
